# パーソナリティ中心コア機能設計レポート（2025-10-14）

## 1. 方針とシステム全体像
- **中核コンセプト**: ユーザーのパーソナリティを多面的に表現し、エピソードマッチング・対話エージェント・イベント生成に共通のシグナルとして活用する。
- **構成原則**
  - 単一の`Personality Profile Service`でパーソナリティデータを集約し、各機能モジュールからAPI経由で参照・更新。
  - コンテキストに応じて「静的（トレイト）」「準動的（状況」「動的（セッション）」の3レイヤでパーソナリティを扱う。
  - 生成AIを利用する各機能は、プロンプト/モデル入力にパーソナリティ特徴と最近の感情状態をバンドルして一貫したトーンを維持。

```
┌─────────────────────────────┐
│ Personality Profile Service                                   │
│  - Baseline Traits  - Narrative Embeddings  - Mood Timeline    │
└──────────────┬───────────────────┬─────────────┘
               │                   │
      Episode Matching Engine   Dialogue Agent Orchestrator   EveGen Planner
               │                   │                           │
        Pairing Suggestions   Conversational Persona         Event Scripts
```

## 2. パーソナリティ表現モデル
| レイヤ | 目的 | データ例 | 取得タイミング | 更新タイミング |
| --- | --- | --- | --- | --- |
| **Baseline Traits** | 長期的な価値観/性格 | Big5類型、自己効力感、望む支援スタイル | 初期オンボーディング＋手動編集 | 半期に一度の見直し or 重大イベント後 |
| **Narrative Embeddings** | エピソード中の語り口・テーマ | LLMで生成した sentence embedding、トーンベクトル、タグ分布 | 各エピソード生成/共有時 | 新エピソード追加時、自動再計算 |
| **State Signals** | 直近の感情・ストレス・信頼度 | リフレクションスコア、睡眠/ストレス自己申告、クールダウン残時間 | エピソード共有直後、dailyタマネギ投稿後 | 1日単位で減衰、リフレクション入力で更新 |

### 2.1 データ構造例
```ts
interface PersonalityProfile {
  userId: string;
  baseline: {
    traits: Record<string, number>; // Big5など0-1正規化
    preferredTone: "gentle" | "direct" | "playful";
    supportExpectations: { guidance: number; validation: number; problemSolving: number; };
  };
  narratives: {
    topicDistribution: Record<string, number>;
    toneVector: number[]; // e.g., 16-d emotion embedding
    representativeEpisodes: string[]; // episode IDs
    affinityKeywords: string[];
  };
  state: {
    affect: { valence: number; arousal: number; stability: number; };
    trustScore: number;
    cooldownRemainingHours: number;
    lastUpdated: string;
  };
}
```

### 2.2 更新フロー
1. **初期化**: パーソナリティ判定チュートリアル＋質問票でbaselineを構築。
2. **エピソード生成時**: LLMがエピソードを要約→埋め込み→`narratives`へ反映。
3. **共有後**: リフレクション入力・相手からのフィードバックで`state`を更新。
4. **周期見直し**: 半期に一度、ユーザーに簡易チェックインを促しBaselineを再評価。

## 3. エピソードマッチング設計示唆
### 3.1 マッチングパイプライン拡張
1. **候補抽出**: 従来のDepth/Exposure差フィルタに加え、`baseline.traits`と`narratives.toneVector`の距離をチェック。
2. **パーソナリティ適合スコア**
   - `traitCompatibility = cosine(baseline.traits, counterpart.baseline.traits)`
   - `toneAffinity = cosine(narratives.toneVector, counterpart.narratives.toneVector)`
   - `supportAlignment = 1 - |supportExpectations - counterpart.supportCapabilities|`
   - 合成スコア = `0.4*trait + 0.3*tone + 0.3*support`
3. **クールダウン/状態考慮**: `state.trustScore`や`cooldownRemaining`が閾値を超えるか確認。高ストレス時はマッチング候補として保留。
4. **説明生成**: パーソナリティ差分を自然言語で要約し、なぜ相性が良いか/注意点を提示。

### 3.2 APIインターフェース案
```graphql
type PersonalityMatchInput {
  targetUserId: ID!
  partnerUserId: ID!
  candidateEpisodes: [EpisodeInput!]!
}

type MatchScore {
  episodePair: EpisodePair!
  depthDelta: Int!
  exposureDelta: Int!
  traitCompatibility: Float!
  toneAffinity: Float!
  supportAlignment: Float!
  overallScore: Float!
  rationale: String!
  alerts: [String!]
}
```
- Matching Engineは`Personality Profile Service`から事前にバッチ取得 or gRPCでリアルタイム参照。
- モニタリング: `overallScore`と共有後のComfortスコアの相関を追跡し重みを調整。

### 3.3 モデル・インフラ
- Embeddingモデル: 日本語・英語両対応の多言語感情embedding（例: instructor-large 日本語fine-tune）。
- フィードバック学習: 共有後の「しっくり度」評価を教師データにし、LightGBM等で重み最適化。

## 4. 対話エージェント設計示唆
### 4.1 アーキテクチャ
```
Conversation Orchestrator
 ├─ Persona Fetcher (Personality Profile API)
 ├─ Prompt Composer (baseline + state + episode context)
 ├─ Safety Guard (crisis lexicon / escalation rules)
 └─ Dialogue Memory Store (short-term / long-term)
```

### 4.2 Persona適用ロジック
- `baseline.preferredTone`をテンプレートに反映し、温度設定・応答スタイルを決定。
- `supportExpectations`に応じて、反映スクリプト（共感→リフレーミング→提案 等）の比率を調整。
- `state.affect`が低安定時は、深掘り質問を抑え、安定化プロンプトを挿入。

#### プロンプト例（抜粋）
```
You are a supportive writing partner. User prefers {preferredTone} tone and values {topSupportNeed} support.
Current affect: valence={valence}, arousal={arousal}. Start with reassurance before asking for details.
```

### 4.3 自己学習・評価
- セッション毎にユーザー満足度アンケートを挿入し、`Persona Fit Score`を算出。
- GPT評定や会話要約により、どこで違和感が生じたかを記録し、Baseline調整候補として提示。
- 安全: `Safety Guard`が危険語を検出した場合、トリアージスクリプトを返し、共有後のリソースカードリンクを表示。

## 5. イベント生成（EveGen）設計示唆
### 5.1 入力と生成フロー
1. **入力データ**
   - パーソナリティ`baseline`（好み・セーフティライン）
   - `narratives.topicDistribution`（興味領域）
   - 最近の`state`（疲労・ストレス指標）
   - 過去イベント履歴とフィードバック
2. **候補イベント生成**
   - LLMに「類似プロフィールの成功例」「季節・地域イベントAPI」などの外部シグナルを与え、草稿プランを生成。
3. **フィルタリング**
   - スコアリングモデルで適合度算出（例: `interestScore`, `supportBalance`, `noveltyScore`）。
   - ハイストレス時は負担の少ないイベント（オンライン対話、軽いチェックイン）を優先。
4. **説明・アクション**
   - イベント提案には「なぜこの提案が適切か」をパーソナリティ視点で言語化。
   - 承諾時はカレンダー連携 or リマインダーを生成。

### 5.2 データ構造例
```ts
interface EventSuggestion {
  id: string;
  userId: string;
  createdAt: string;
  summary: string;
  rationale: string;
  recommendedParticipants: string[];
  requiredTrustLevel: number;
  predictedEffort: number;
  tags: string[];
  sourceSignals: string[]; // personality traits, topics, feedback ids
}
```

### 5.3 評価指標
- 提案受諾率・実行率
- 実行後のリフレクションによる満足度
- クールダウン消費の適正度（過剰チャレンジ抑制）

## 6. データガバナンスと安全
- **分離保管**: パーソナリティプロファイルは暗号化ストレージ＋アクセス制御。各モジュールは最小限フィールドにアクセス。
- **監査ログ**: プロファイル更新履歴・マッチングレスポンス・対話ログを匿名化して保持し、誤動作時にトレース可能に。
- **ヒューマンレビュー**: 深さ7以上、TrustScoreが急落した場合のマッチングは人間モデレーターが承認。

## 7. 今後の検討ポイント
1. Baseline Traitsの収集方法（心理尺度 vs 簡易質問）とUX負荷バランス。
2. Embeddingモデルの保守（感情語彙のアップデート、バイアス評価）。
3. マッチング・対話・イベント間でのフィードバックループ統合（例: イベント成功→トラスト上昇→次のマッチ基準緩和）。
4. 安全プロトコルとの統合テスト計画（危機検知時の優先度・ログ）。

---
このレポートはパーソナリティ表現を中軸としたバックエンド機能実装の骨子を示すものです。各モジュールの詳細仕様・API定義は今後のスプリントで精緻化してください。
