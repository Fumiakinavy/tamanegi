# 概要
`output/タマネギアプリ/設計/バックエンド/エージェント/エピソードマッチングエージェント.md`は、ペアタマネギ作成時に用いるエピソードマッチング処理の内部設計をまとめたドキュメント。入力データ、フィルタリング手順、スコア差判定、説明生成までの一連のフローを記述している。

# 目的
- 相互開示時に安全かつ納得感の高いエピソードペアを提示するためのアルゴリズム要件を整理する。
- LLM/スコアリング/安全ポリシーの連携ポイントを明確化し、バックエンド実装とQAの指針にする。

# 最適な実装方法
1. スコア差・トーン相性・安全チェックの3段階でフィルタリングするパイプラインを採用。
2. Mermaidフローチャートで主要ステップを可視化し、ログ出力と説明生成の責務境界を定義。
3. ポリシー閾値やユーザー設定を外部化し、実験的なチューニングを可能にする。

# 最適と思われる理由
- 既存コンセプトで定義されている深さ・露出スコアと安全配慮を、実際のアルゴリズムに落とし込める。
- 説明生成を組み込むことで、ユーザー体験で求められる「理由の透明性」を担保できる。

# 入出力
- 入力: ユーザーコンテキスト、エピソードメタデータ（Depth/Exposure/Complexity/Support Need/トーン/危機フラグ）、ポリシー設定。
- 出力: マッチング結果ステータス、選定層ID、スコア差、生成された説明テキスト、警告アラート。

# 実装の評価
- マッチ成立・棄却がポリシー通りにログされ、説明文がユーザーに理解しやすい形で返ること。
- コンフォートスコアや安全アラート指標をモニタリングし、閾値調整のフィードバックループが築けているか。
